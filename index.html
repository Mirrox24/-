<!DOCTYPE html>
<html lang="ru" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–°–±–µ—Ä—ë–Ω–æ–∫ | –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü–æ–º–æ—â–Ω–∏–∫</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º datalabels –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–π –Ω–∞ –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º–µ -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-main: #f0f4f9; /* –°–≤–µ—Ç–ª–æ-–≥–æ–ª—É–±–æ–π/—Å–µ—Ä—ã–π —Ñ–æ–Ω */
            --bg-card: #ffffff;
            --text-primary: #1c1c1c;
            --text-secondary: #606060;
            --accent: #4CAF50; /* Sber Green –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            --accent-light: #e8f5e9;
            --border-color: #e0e0e0;
            --balance-text-color: #ffffff; /* –¶–≤–µ—Ç –±–∞–ª–∞–Ω—Å–∞ –Ω–∞ –∞–∫—Ü–µ–Ω—Ç–Ω–æ–º —Ñ–æ–Ω–µ */
        }
        html.dark {
            --bg-main: #1f2937;
            --bg-card: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --accent-light: #2e7d32;
            --border-color: #4b5563;
            --balance-text-color: #ffffff;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); }
        .phone-frame { max-width: 420px; height: 100vh; }
        @media (min-width: 421px) { .phone-frame { height: 90vh; max-height: 800px; border: 8px solid #222; border-radius: 40px; } }
        
        .view { display: none; }
        .view.active { display: block; animation: fadeIn 0.3s ease-out forwards; }
        .nav-btn.active svg, .nav-btn.active span { color: var(--accent); font-weight: 600; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ –∞–Ω–∏–º–∞—Ü–∏–∏ */
        .xp-bar-fill { transition: width 0.5s ease-in-out, background-color 0.3s; }
        .card-animate:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .card-animate { transition: all 0.2s ease-in-out; }

        /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –∞–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç */
        body { --accent: var(--user-accent-color, #4CAF50); }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ */
        .typing-indicator span {
            animation: blink 1.4s infinite both;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0% { opacity: 0.2; }
            20% { opacity: 1; }
            100% { opacity: 0.2; }
        }
    </style>
</head>
<body class="bg-gray-200 flex items-center justify-center">

    <div id="app-container" class="phone-frame bg-[var(--bg-main)] flex flex-col w-full overflow-hidden shadow-2xl">
        <main class="flex-1 overflow-y-auto relative p-6 space-y-6">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è –∫–æ–Ω—Ç–µ–Ω—Ç -->
        </main>
        <footer class="flex-shrink-0 bg-[var(--bg-card)] border-t border-[var(--border-color)] grid grid-cols-6 gap-2 px-2 py-3" id="nav-footer">
            <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        </footer>
    </div>
    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>
    <div id="toast-container" class="fixed top-5 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center gap-2"></div>

<script>
// SBERENOK v9.0 - Ultimate AI Assistant Edition
document.addEventListener('DOMContentLoaded', () => {

    // --- CONFIGURATION & STATE ---
    let pieChart, barChart;
    const XP_PER_LEVEL = 100;
    
    const BRIGHT_COLORS = ['#FF9800', '#2196F3', '#FFEB3B', '#9C27B0', '#00BCD4', '#E91E63', '#4CAF50'];

    const characterStyles = {
        'default': { name: '–û–±—ã—á–Ω—ã–π', img: 'https://i.ibb.co/3k5qZJd/sberenok-avatar.png' },
        'superhero': { name: '–ì–µ—Ä–æ–π', img: 'https://i.ibb.co/j3YF9b7/sberenok-hero.png', requiredAchievement: 'tasks_10' },
        'wizard': { name: '–ú–∞–≥', img: 'https://i.ibb.co/L8yV0Sj/sberenok-wizard.png', requiredAchievement: 'savings_1000' },
        'artist': { name: '–•—É–¥–æ–∂–Ω–∏–∫', img: 'https://i.ibb.co/b3D0bJg/sberenok-artist.png', requiredAchievement: 'lessons_5' },
    };

    const achievementConfig = {
        'tasks_1': { name: '–ü–µ—Ä–≤—ã–π —à–∞–≥', description: '–í—ã–ø–æ–ª–Ω–∏—Ç—å 1 –∑–∞–¥–∞—á—É', goalKey: 'completedTasks', goalValue: 1, xp: 10, unlockedSkin: null },
        'tasks_10': { name: '–î–µ—Å—è—Ç–∫–∞!', description: '–í—ã–ø–æ–ª–Ω–∏—Ç—å 10 –∑–∞–¥–∞—á', goalKey: 'completedTasks', goalValue: 10, xp: 50, unlockedSkin: 'superhero' },
        'savings_1000': { name: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å', description: '–ù–∞–∫–æ–ø–∏—Ç—å 1000 ‚ÇΩ', goalKey: 'totalSavings', goalValue: 1000, xp: 100, unlockedSkin: 'wizard' },
        'lessons_1': { name: '–£—á–µ–Ω–∏–∫', description: '–ü—Ä–æ–π—Ç–∏ 1 —É—Ä–æ–∫', goalKey: 'lessonsCompleted', goalValue: 1, xp: 20, unlockedSkin: null },
        'lessons_5': { name: '–ó–Ω–∞—Ç–æ–∫', description: '–ü—Ä–æ–π—Ç–∏ 5 —É—Ä–æ–∫–æ–≤', goalKey: 'lessonsCompleted', goalValue: 5, xp: 75, unlockedSkin: 'artist' },
    };
    
    const spendingCategories = {
        '–ï–¥–∞': BRIGHT_COLORS[1], '–ò–≥—Ä—ã': BRIGHT_COLORS[0], '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è': BRIGHT_COLORS[2], 
        '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': BRIGHT_COLORS[3], '–ü–æ–¥–∞—Ä–∫–∏': BRIGHT_COLORS[4], '–ü—Ä–æ—á–µ–µ': BRIGHT_COLORS[5], 
    };

    // –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ö–ê–î–ï–ú–ò–Ø –° –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ú–ò –ü–†–û–ú–ü–¢–ê–ú–ò –î–õ–Ø –ò–ò
    const academyLessons = {
        'money-101': { title: '–ß—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–Ω—å–≥–∏?', icon: 'üí∞', xp: 25, prompt: '–æ–±—ä—è—Å–Ω–∏ —Ä–µ–±–µ–Ω–∫—É 10 –ª–µ—Ç, —á—Ç–æ —Ç–∞–∫–æ–µ –¥–µ–Ω—å–≥–∏, –∏—Ö —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –ø–æ—á–µ–º—É –æ–Ω–∏ –Ω–µ —Ä–∞—Å—Ç—É—Ç –Ω–∞ –¥–µ—Ä–µ–≤—å—è—Ö.' },
        'budget-basics': { title: '–ë—é–¥–∂–µ—Ç: 4 –∫–æ–Ω–≤–µ—Ä—Ç–∞', icon: 'üìä', xp: 25, prompt: '–∫–∞–∫ —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å –±—é–¥–∂–µ—Ç –∏–∑ –∫–∞—Ä–º–∞–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥? –û–±—ä—è—Å–Ω–∏ –ø—Ä–∞–≤–∏–ª–æ "4 –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤" –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ, –ø—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä —Å —Å—É–º–º–æ–π 500 —Ä—É–±–ª–µ–π –≤ –Ω–µ–¥–µ–ª—é.' },
        'discounts-intro': { title: '–°–∫–∏–¥–∫–∏: –í—ã–≥–æ–¥–∞ –∏–ª–∏ –ª–æ–≤—É—à–∫–∞?', icon: 'üè∑Ô∏è', xp: 25, prompt: '–æ–±—ä—è—Å–Ω–∏, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Å–∫–∏–¥–∫–∏, –∏ –Ω–∞—É—á–∏ –æ—Ç–ª–∏—á–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â—É—é –≤—ã–≥–æ–¥—É –æ—Ç –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã—Ö —É–ª–æ–≤–æ–∫. –ü—Ä–∏–≤–µ–¥–∏ –ø—Ä–∏–º–µ—Ä —Å –ø–æ–∫—É–ø–∫–æ–π –∫—Ä–æ—Å—Å–æ–≤–æ–∫.' },
        'savings-why': { title: '–ö–æ–ø–∏–ª–∫–∞ vs. –ë–∞–Ω–∫', icon: 'üè¶', xp: 25, prompt: '–æ–±—ä—è—Å–Ω–∏ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É —Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –¥–µ–Ω–µ–≥ –≤ –∫–æ–ø–∏–ª–∫–µ –∏ –≤ –±–∞–Ω–∫–µ, –∞ —Ç–∞–∫–∂–µ —á—Ç–æ —Ç–∞–∫–æ–µ –ø—Ä–æ—Ü–µ–Ω—Ç –Ω–∞ –æ—Å—Ç–∞—Ç–æ–∫. –°–¥–µ–ª–∞–π –∞–∫—Ü–µ–Ω—Ç –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ä–æ—Å—Ç–µ –¥–µ–Ω–µ–≥.' },
        'first-card': { title: '–ú–æ—è –ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞', icon: 'üí≥', xp: 30, prompt: '—Ä–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ –≥–ª–∞–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç—ã. –ß—Ç–æ —Ç–∞–∫–æ–µ –ü–ò–ù-–∫–æ–¥, CVV –∏ –ø–æ—á–µ–º—É –∏—Ö –Ω–µ–ª—å–∑—è –Ω–∏–∫–æ–º—É –≥–æ–≤–æ—Ä–∏—Ç—å?' },
        'online-scammers': { title: '–û—Å—Ç–æ—Ä–æ–∂–Ω–æ, –º–æ—à–µ–Ω–Ω–∏–∫–∏!', icon: 'üëª', xp: 30, prompt: '–æ–ø–∏—à–∏ 3 —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞ –æ–±–º–∞–Ω–∞ –¥–µ—Ç–µ–π –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ñ–µ–π–∫–æ–≤—ã–µ –∫–æ–Ω–∫—É—Ä—Å—ã, –ø—Ä–æ—Å—å–±—ã "–¥—Ä—É–∑–µ–π" –≤ —Å–æ—Ü—Å–µ—Ç—è—Ö) –∏ –∫–∞–∫ –Ω–∞ –Ω–∏—Ö –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è.' },
        'needs-vs-wants': { title: '–•–æ—á—É vs. –ù–∞–¥–æ', icon: 'ü§î', xp: 30, prompt: '–æ–±—ä—è—Å–Ω–∏ —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—è–º–∏ (–µ–¥–∞, –æ–¥–µ–∂–¥–∞) –∏ –∂–µ–ª–∞–Ω–∏—è–º–∏ (–Ω–æ–≤–∞—è –∏–≥—Ä–∞, —Å–ª–∞–¥–æ—Å—Ç–∏). –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–∞—Å—Å—Ç–∞–≤–ª—è—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø—Ä–∏ –ø–æ–∫—É–ø–∫–∞—Ö?' },
        'earning-first-money': { title: '–ü–µ—Ä–≤—ã–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫', icon: 'üõ†Ô∏è', xp: 30, prompt: '–ø—Ä–µ–¥–ª–æ–∂–∏ 4-5 –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–¥–µ–π, –∫–∞–∫ –ø–æ–¥—Ä–æ—Å—Ç–æ–∫ 12-14 –ª–µ—Ç –º–æ–∂–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å —Å–≤–æ–∏ –ø–µ—Ä–≤—ã–µ –∫–∞—Ä–º–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ (–ø–æ–º–æ—â—å —Å–æ—Å–µ–¥—è–º, –≤—ã–≥—É–ª —Å–æ–±–∞–∫ –∏ —Ç.–¥.).' }
    };
    
    const DOM = {
        main: document.querySelector('main'), nav: document.getElementById('nav-footer'),
        modal: document.getElementById('modal-container'), toast: document.getElementById('toast-container'),
        appContainer: document.querySelector('body'),
    };

    let appState = {}; 

    // --- STATE MANAGEMENT ---
    function loadState() {
        const savedState = JSON.parse(localStorage.getItem('sberenokState_v9'));
        const defaultState = {
            ui: { currentView: 'home', theme: 'light', isAiTyping: false, accentColor: '#4CAF50', isChatInitiated: false },
            user: {
                name: "–ê–ª–µ–∫—Å", surname: "–°–º–∏—Ä–Ω–æ–≤", characterStyle: 'default', balance: 1350.75,
                level: 1, xp: 10,
                goals: [{ id: Date.now(), name: "–ö—Ä—É—Ç–æ–π —Å–∫–µ–π—Ç–±–æ—Ä–¥ üõπ", current: 2800, target: 4500 }],
                schedule: [ { id: 1, task: "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å—Å—è –∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π", done: false, xpEarned: false }, { id: 2, task: "–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –ø–æ –ø–ª–∞–≤–∞–Ω–∏—é", done: true, xpEarned: true } ],
                spendingHistory: [
                    { id: 1, date: '2025-09-20', amount: 50.00, category: '–ï–¥–∞', desc: '–ú–æ—Ä–æ–∂–µ–Ω–æ–µ' }, { id: 2, date: '2025-09-22', amount: 200.50, category: '–ò–≥—Ä—ã', desc: '–î–æ–Ω–∞—Ç –≤ –ª—é–±–∏–º–æ–π –∏–≥—Ä–µ' },
                    { id: 3, date: '2025-09-23', amount: 80.25, category: '–ï–¥–∞', desc: '–ß–∏–ø—Å—ã –∏ –∫–æ–ª–∞' }, { id: 4, date: '2025-09-25', amount: 150.00, category: '–ü–æ–¥–∞—Ä–∫–∏', desc: '–ü–æ–¥–∞—Ä–æ–∫ –¥—Ä—É–≥—É' },
                    { id: 5, date: '2025-09-26', amount: 120.00, category: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', desc: '–ü–æ–µ–∑–¥–∫–∞ –Ω–∞ –∞–≤—Ç–æ–±—É—Å–µ' },
                ],
                stats: { completedTasks: 1, totalSavings: 2800, lessonsCompleted: 0, goalsAchieved: 0 }, 
                unlockedSkins: ['default'], completedLessons: [], achievements: []
            },
            chat: { history: [] },
        };
        appState = savedState || defaultState;
        appState.ui.currentView = 'home';
        appState.ui.isChatInitiated = false; 
        applyTheme(); 
        saveState();
    }
    function saveState() { localStorage.setItem('sberenokState_v9', JSON.stringify(appState)); }

    // --- CORE RENDERING & NAVIGATION ---
    function navigate(viewId) { appState.ui.currentView = viewId; render(); }
    function render() { renderNav(); renderView(); }
    
    function renderNav() {
        const buttons = [
            { id: 'home', icon: '<path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>', label: '–ì–ª–∞–≤–Ω–∞—è' },
            { id: 'piggy-bank', icon: '<path d="M10 18V8a4 4 0 1 1 8 0v10M2 22h20"/>', label: '–ö–æ–ø–∏–ª–∫–∞' },
            { id: 'ai-assistant', icon: '<path d="M12 8V4H8"/> <rect width="16" height="12" x="4" y="8" rx="2"/> <path d="M2 14h2"/> <path d="M20 14h2"/> <path d="M15 13v2"/> <path d="M9 13v2"/>', label: '–°–±–µ—Ä—ë–Ω–æ–∫' },
            { id: 'schedule', icon: '<rect width="18" height="18" x="3" y="4" rx="2"/><path d="M8 2v4M16 2v4M3 10h18"/>', label: '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ' },
            { id: 'academy', icon: '<path d="m4 6 8-4 8 4 8-4"/> <path d="M4 10v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10"/>', label: '–ê–∫–∞–¥–µ–º–∏—è' },
            { id: 'profile', icon: '<circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/>', label: '–ü—Ä–æ—Ñ–∏–ª—å' }
        ];
        DOM.nav.innerHTML = buttons.map(btn => `
            <button data-action="navigate" data-view="${btn.id}" class="nav-btn flex flex-col items-center text-gray-500 dark:text-gray-400 text-xs space-y-1 ${appState.ui.currentView === btn.id ? 'active' : ''}">
                <svg xmlns="http://www.w.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${btn.icon}</svg>
                <span>${btn.label}</span>
            </button>`).join('');
    }

    async function renderView() {
        const viewId = appState.ui.currentView;
        let content = '';
        const contextualHelpButton = (prompt, persona) => `
            <button data-action="show-ai-help" data-prompt="${prompt}" data-persona="${persona}" class="absolute top-5 right-5 w-10 h-10 bg-[var(--accent)] text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105 active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.84 0-3.32 1.07-3.9 2.5a5.5 5.5 0 0 0-7.15 4.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
            </button>
        `;

        switch(viewId) {
            case 'home': content = getHomeHTML(); break;
            case 'piggy-bank': content = getPiggyBankHTML() + contextualHelpButton('–î–∞–π –º–Ω–µ 3 —Å–æ–≤–µ—Ç–∞, –∫–∞–∫ –±—ã—Å—Ç—Ä–µ–µ –Ω–∞–∫–æ–ø–∏—Ç—å –Ω–∞ –º–æ—é —Ç–µ–∫—É—â—É—é —Ü–µ–ª—å.', 'assistant'); break;
            case 'schedule': content = getScheduleHTML() + contextualHelpButton('–ü–æ–º–æ–≥–∏ –º–Ω–µ —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞, —á—Ç–æ–±—ã –≤—Å–µ —É—Å–ø–µ—Ç—å.', 'planner'); break;
            case 'academy': content = getAcademyHTML() + contextualHelpButton('–ö–∞–∫–∏–µ —É—Ä–æ–∫–∏ –º–Ω–µ —Å—Ç–æ–∏—Ç –ø—Ä–æ–π—Ç–∏ —Å–µ–π—á–∞—Å, —á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —Å–≤–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ?', 'assistant'); break;
            case 'profile': content = getProfileHTML(); break;
            case 'ai-assistant': content = getChatAssistantHTML(); break;
        }
        DOM.main.innerHTML = `<div class="view active">${content}</div>`;
        if (viewId === 'piggy-bank') renderCharts();
        if (viewId === 'ai-assistant') renderChatMessages();
    }
    
    // --- HTML GETTERS (VIEWS) ---
    function getHomeHTML() {
        const charImg = characterStyles[appState.user.characterStyle].img;
        const tasksLeft = appState.user.schedule.filter(t => !t.done).length;
        const totalSavings = appState.user.goals.reduce((sum, g) => sum + g.current, 0);
        
        return `
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-extrabold text-[var(--text-primary)]">–°–±–µ—Ä—ë–Ω–æ–∫</h1>
                <img src="${charImg}" class="w-12 h-12 rounded-full border-2 border-[var(--accent)] shadow-md">
            </div>

            <div class="bg-[var(--accent)] p-6 rounded-2xl shadow-xl card-animate">
                <p class="text-lg opacity-90 text-[var(--balance-text-color)]">–ú–æ–π —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</p>
                <p class="text-5xl font-extrabold mt-1 text-[var(--balance-text-color)]">${appState.user.balance.toFixed(2)} ‚ÇΩ</p>
                <div class="flex justify-between mt-4 border-t border-white/30 pt-3 text-sm text-[var(--balance-text-color)]">
                    <span>–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è:</span>
                    <span>${totalSavings.toFixed(2)} ‚ÇΩ</span>
                </div>
            </div>

            <h2 class="text-xl font-bold mt-6 mb-3">–ú–æ–∏ —Ü–µ–ª–∏</h2>
            ${appState.user.goals.length > 0 ? 
                appState.user.goals.slice(0, 1).map(goal => {
                    const progress = Math.min(100, (goal.current / goal.target) * 100);
                    return `
                        <div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-md card-animate">
                            <h3 class="font-bold text-lg">${goal.name}</h3>
                            <p class="text-sm text-[var(--text-secondary)]">${goal.current.toFixed(0)} ‚ÇΩ –∏–∑ ${goal.target.toFixed(0)} ‚ÇΩ</p>
                            <div class="w-full bg-[var(--border-color)] rounded-full h-2.5 my-2">
                                <div class="bg-[var(--accent)] h-2.5 rounded-full xp-bar-fill" style="width: ${progress}%"></div>
                            </div>
                            <button data-action="navigate" data-view="piggy-bank" class="mt-2 text-xs font-medium text-[var(--accent)]">–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Ü–µ–ª—è—Ö</button>
                        </div>`;
                }).join('') : `<div class="bg-[var(--bg-card)] p-4 rounded-xl text-center shadow-md text-[var(--text-secondary)]">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ü–µ–ª–µ–π. –ù–∞—á–Ω–∏ –∫–æ–ø–∏—Ç—å!</div>`}

            <h2 class="text-xl font-bold mt-6 mb-3">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div class="grid grid-cols-3 gap-3">
                <button data-action="navigate" data-view="ai-assistant" class="bg-[var(--accent-light)] text-[var(--accent)] p-4 rounded-xl shadow-sm font-medium text-center flex flex-col items-center card-animate">
                    <span class="text-2xl mb-1">üí°</span> –°–±–µ—Ä—ë–Ω–æ–∫
                </button>
                <button data-action="navigate" data-view="schedule" class="bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 p-4 rounded-xl shadow-sm font-medium text-center flex flex-col items-center card-animate">
                    <span class="text-2xl mb-1">‚úÖ</span> ${tasksLeft} –ó–∞–¥–∞—á
                </button>
                <button data-action="add-expense" class="bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300 p-4 rounded-xl shadow-sm font-medium text-center flex flex-col items-center card-animate">
                    <span class="text-2xl mb-1">üí∏</span> –¢—Ä–∞—Ç–∞
                </button>
            </div>`;
    }

    function getPiggyBankHTML() {
        // ... (HTML remains largely the same, but will be re-rendered with new charts)
        const goalsHTML = appState.user.goals.map(goal => {
            const progress = Math.min(100, (goal.current / goal.target) * 100);
            const isAchieved = goal.current >= goal.target;
            return `
                <div class="bg-[var(--bg-card)] p-5 rounded-2xl shadow-sm border-l-4 ${isAchieved ? 'border-[var(--accent)]' : 'border-gray-400'}">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-bold text-lg">${goal.name}</h3>
                        <div class="flex gap-2">
                           <button data-action="edit-goal" data-goal-id="${goal.id}" class="text-sm text-[var(--text-secondary)] hover:text-[var(--accent)]">‚úèÔ∏è</button>
                           <button data-action="delete-goal" data-goal-id="${goal.id}" class="text-sm text-red-500 hover:text-red-700">üóëÔ∏è</button>
                        </div>
                    </div>
                    <p class="text-md font-semibold text-[var(--text-secondary)]">${goal.current.toFixed(2)} ‚ÇΩ / ${goal.target.toFixed(2)} ‚ÇΩ</p>
                    <div class="w-full bg-[var(--border-color)] rounded-full h-2.5 my-2">
                        <div class="bg-[var(--accent)] h-2.5 rounded-full xp-bar-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="flex gap-2 justify-end mt-3">
                        <button data-action="add-funds" data-goal-id="${goal.id}" class="bg-[var(--accent)] text-white px-3 py-1 rounded-lg text-sm font-medium transition-all active:scale-95">–î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                </div>`;
        }).join('');

        return `
            <h1 class="text-2xl font-bold mb-4">–ú–æ—è –ö–æ–ø–∏–ª–∫–∞ & –§–∏–Ω–∞–Ω—Å—ã</h1>
            <div class="space-y-4">
                ${goalsHTML}
                <button data-action="add-goal" class="w-full bg-[var(--bg-card)] p-4 rounded-xl shadow-sm border-2 border-dashed border-[var(--border-color)] text-[var(--text-secondary)] font-medium transition-colors active:bg-[var(--border-color)] card-animate">
                    + –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ü–µ–ª—å
                </button>
            </div>
            
            <h2 class="text-xl font-bold mt-6 mb-3">–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</h2>
            <button data-action="add-expense" class="w-full bg-red-500/20 text-red-700 dark:bg-red-900/40 dark:text-red-300 p-3 rounded-xl shadow-sm font-medium mb-4 transition-colors active:scale-[.99]">
                üí∏ –ó–∞–ø–∏—Å–∞—Ç—å –Ω–æ–≤—ã–π —Ä–∞—Å—Ö–æ–¥
            </button>
            
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-lg text-center w-full card-animate">
                    <h3 class="font-semibold mb-2 text-sm">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h3>
                    <canvas id="spendingPieChart" class="w-full" style="max-height: 280px;"></canvas>
                </div>
                <div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-lg text-center w-full card-animate">
                    <h3 class="font-semibold mb-2 text-sm">–†–∞—Å—Ö–æ–¥—ã –∑–∞ –Ω–µ–¥–µ–ª—é</h3>
                    <canvas id="balanceBarChart" class="w-full" style="max-height: 280px;"></canvas>
                </div>
            </div>`;
    }

    function getScheduleHTML() {
        // ... (HTML remains largely the same, logic is sound)
         const tasksHTML = appState.user.schedule.map(task => `
            <div class="flex items-center gap-3 p-4 rounded-xl bg-[var(--bg-card)] shadow-sm">
                <input id="task-${task.id}" type="checkbox" data-action="toggle-task" data-task-id="${task.id}" ${task.done ? 'checked' : ''} class="form-checkbox h-6 w-6 text-[var(--accent)] rounded-lg focus:ring-[var(--accent)] transition-colors">
                <label for="task-${task.id}" class="flex-1 text-md font-medium ${task.done ? 'line-through text-[var(--text-secondary)]' : ''}">${task.task}</label>
                ${task.done && task.xpEarned ? '<span class="text-xs text-[var(--accent)] font-bold">XP+</span>' : ''}
            </div>
        `).join('');

        return `
            <h1 class="text-2xl font-bold mb-4">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ & –ó–∞–¥–∞—á–∏</h1>
            <div class="space-y-3">
                ${appState.user.schedule.length > 0 ? tasksHTML : `<p class="text-center text-[var(--text-secondary)] p-4">–ó–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–¥—ã—Ö–∞–π!</p>`}
            </div>
            <button data-action="add-task-modal" class="w-full bg-[var(--bg-card)] p-4 rounded-xl shadow-sm border-2 border-dashed border-[var(--border-color)] text-[var(--text-secondary)] font-medium mt-4 transition-colors active:bg-[var(--border-color)]">
                + –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
            </button>
            <button data-action="ai-action" data-prompt="–°–æ—Å—Ç–∞–≤—å –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π –ø–ª–∞–Ω –¥–Ω—è, –∏—Å–ø–æ–ª—å–∑—É—è –º–æ–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏." data-persona="planner" class="w-full bg-[var(--accent-light)] text-[var(--accent)] p-4 rounded-xl shadow-sm font-medium mt-3 transition-colors active:scale-[.99]">
                üí° –ü–æ–ø—Ä–æ—Å–∏—Ç—å –°–±–µ—Ä—ë–Ω–∫–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –¥–Ω—è
            </button>`;
    }

    function getAcademyHTML() {
        return `
            <h1 class="text-2xl font-bold mb-4">–ê–∫–∞–¥–µ–º–∏—è –§–∏–Ω–∞–Ω—Å–æ–≤</h1>
            <p class="text-[var(--text-secondary)] mb-6">–£—á–∏—Å—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ —Å–æ –°–±–µ—Ä—ë–Ω–∫–æ–º –∏ –ø–æ–ª—É—á–∞–π XP –∑–∞ –∫–∞–∂–¥—ã–π —É—Ä–æ–∫!</p>
            <div class="space-y-4">
            ${Object.entries(academyLessons).map(([key, lesson]) => {
                const isCompleted = appState.user.completedLessons.includes(key);
                return `
                <button data-action="start-lesson" data-lesson-id="${key}" class="w-full text-left p-4 rounded-xl bg-[var(--bg-card)] shadow-md flex items-center justify-between transition-transform active:scale-95 card-animate border-l-4 ${isCompleted ? 'border-[var(--accent)]' : 'border-blue-400'}">
                    <div class="flex items-center gap-4">
                        <span class="text-3xl">${lesson.icon}</span>
                        <div>
                            <span class="font-semibold">${lesson.title}</span>
                            <p class="text-sm text-[var(--text-secondary)]">+${lesson.xp} XP</p>
                        </div>
                    </div>
                    ${isCompleted ? `<span class="text-[var(--accent)] font-bold text-sm">‚úì –ü—Ä–æ–π–¥–µ–Ω–æ</span>` : '<span class="text-gray-400 font-medium text-sm">–ù–∞—á–∞—Ç—å</span>'}
                </button>`
            }).join('')}
            </div>`;
    }

    function getProfileHTML() {
        const { name, surname, level, xp, unlockedSkins, characterStyle } = appState.user;
        const progress = (xp / XP_PER_LEVEL) * 100;
        
        const achievementsHTML = Object.values(achievementConfig).map(ach => {
            const isUnlocked = appState.user.achievements.includes(ach.name);
            return `<div class="p-3 bg-[var(--bg-card)] rounded-lg flex items-center gap-3 border-l-4 ${isUnlocked ? 'border-[var(--accent)]' : 'border-[var(--border-color)]'}"><div class="w-12 h-12 flex items-center justify-center rounded-full bg-[var(--accent-light)] text-2xl">${isUnlocked ? 'üèÜ' : 'üîí'}</div><div><h4 class="font-medium">${ach.name}</h4><p class="text-sm text-[var(--text-secondary)]">${ach.description}</p></div></div>`;
        }).join('');
        
        const colorPalette = [ { name: '–°–±–µ—Ä Green', hex: '#4CAF50' }, { name: 'Sky Blue', hex: '#2196F3' }, { name: 'Sunset Orange', hex: '#FF9800' }, { name: 'Hot Pink', hex: '#E91E63' }, { name: 'Royal Purple', hex: '#9C27B0'} ];

        return `
            <div class="text-center">
                <img src="${characterStyles[characterStyle].img}" class="w-28 h-28 rounded-full border-4 border-[var(--accent)] shadow-lg mx-auto mb-3">
                <h1 class="text-2xl font-bold">${name} ${surname}</h1>
                <p class="text-sm text-[var(--text-secondary)]">–£—Ä–æ–≤–µ–Ω—å ${level}</p>
                <div class="w-full bg-[var(--border-color)] rounded-full h-2.5 mt-2">
                    <div class="bg-[var(--accent)] h-2.5 rounded-full xp-bar-fill" style="width: ${progress}%"></div>
                </div>
                <p class="text-xs text-right text-[var(--text-secondary)] mt-1">${xp} / ${XP_PER_LEVEL} XP</p>
            </div>

            <h2 class="text-xl font-bold mt-6 mb-3">–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-sm"><div class="flex justify-between items-center text-sm"><span>${name} ${surname}</span><button data-action="edit-profile" class="text-[var(--accent)] text-sm font-medium">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button></div></div>

            <h2 class="text-xl font-bold mt-6 mb-3">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h2>
            <div class="bg-[var(--bg-card)] p-4 rounded-xl shadow-sm space-y-4">
                <button data-action="toggle-theme" class="w-full flex justify-between items-center font-medium"><span>–¢–µ–º–∞: ${appState.ui.theme === 'light' ? '–°–≤–µ—Ç–ª–∞—è ‚òÄÔ∏è' : '–¢–µ–º–Ω–∞—è üåô'}</span><span class="text-[var(--accent)]">–°–º–µ–Ω–∏—Ç—å</span></button>
                <h3 class="font-medium text-sm border-t border-[var(--border-color)] pt-3">–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π —Ü–≤–µ—Ç</h3>
                <div class="flex justify-around gap-2">
                    ${colorPalette.map(color => `<button data-action="change-accent-color" data-color="${color.hex}" class="w-10 h-10 rounded-full shadow-md transition-all active:scale-90" style="background-color: ${color.hex}; border: 3px solid ${appState.ui.accentColor === color.hex ? 'var(--text-primary)' : 'transparent'};" title="${color.name}"></button>`).join('')}
                </div>
            </div>

            <h2 class="text-xl font-bold mt-6 mb-3">–°–∫–∏–Ω—ã –ü–æ–º–æ—â–Ω–∏–∫–∞</h2>
            <div class="grid grid-cols-4 gap-3">
                ${Object.entries(characterStyles).map(([key, char]) => `
                    <div class="character-option flex flex-col items-center">
                        <input type="radio" id="char-${key}" name="character-select" value="${key}" class="hidden" ${characterStyle === key ? 'checked' : ''} ${!unlockedSkins.includes(key) ? 'disabled' : ''}>
                        <label for="char-${key}" data-action="change-character" data-char-key="${key}" class="relative w-20 h-20 rounded-full border-2 border-[var(--border-color)] overflow-hidden cursor-pointer transition-transform active:scale-95 duration-200" style="${characterStyle === key ? 'border-color: var(--accent); border-width: 4px;' : ''}">
                            <img src="${char.img}" class="w-full h-full object-cover"><span class="unlock-badge absolute inset-0 bg-black/50 text-white font-bold rounded-full items-center justify-center text-center text-sm ${unlockedSkins.includes(key) ? 'hidden' : 'flex'}">üîí</span>
                        </label>
                        <span class="mt-1 text-xs text-[var(--text-primary)]">${char.name}</span>
                    </div>`).join('')}
            </div>

            <h2 class="text-xl font-bold mt-6 mb-3">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
            <div class="space-y-2">${achievementsHTML}</div>`;
    }
    
    function getChatAssistantHTML() {
        return `
            <h1 class="text-2xl font-bold mb-4">–°–±–µ—Ä—ë–Ω–æ–∫ ‚Äî AI –ü–æ–º–æ—â–Ω–∏–∫</h1>
            <div id="chat-history" class="space-y-4 flex flex-col pb-4 h-[calc(100vh-350px)] overflow-y-auto bg-[var(--bg-main)] p-2 rounded-xl border border-[var(--border-color)]"></div>
            <div id="ai-typing-indicator" class="typing-indicator flex items-center space-x-1 my-2 ${appState.ui.isAiTyping ? '' : 'hidden'}">
                <img src="${characterStyles[appState.user.characterStyle].img}" class="w-6 h-6 rounded-full opacity-50"><span class="text-sm text-[var(--text-secondary)]">–°–±–µ—Ä—ë–Ω–æ–∫ –¥—É–º–∞–µ—Ç<span>.</span><span>.</span><span>.</span></span>
            </div>
            <div class="mt-4">
                <h3 class="font-bold mb-2 text-sm">–ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã</h3>
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <button data-action="ai-action" data-prompt="–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –º–æ–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ç—Ä–∞—Ç –∏ —Å–∫–∞–∂–∏, –≥–¥–µ —è –º–æ–≥—É —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å." data-persona="financial-analyst" class="flex-shrink-0 bg-blue-500/10 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300 px-3 py-1 rounded-full text-xs transition-all active:scale-95">–ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤</button>
                    <button data-action="ai-action" data-prompt="–ü—Ä–µ–¥–ª–æ–∂–∏ 3 –∏–¥–µ–∏ –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –∫–∞—Ä–º–∞–Ω–Ω—ã—Ö –¥–µ–Ω–µ–≥ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ." data-persona="earning-ideas" class="flex-shrink-0 bg-green-500/10 text-green-700 dark:bg-green-900/40 dark:text-green-300 px-3 py-1 rounded-full text-xs transition-all active:scale-95">–ò–¥–µ–∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞</button>
                    <button data-action="ai-action" data-prompt="–î–∞–π —Å–æ–≤–µ—Ç, –∫–∞–∫ –Ω–µ –æ—Ç–≤–ª–µ–∫–∞—Ç—å—Å—è –Ω–∞ –∏–≥—Ä—ã, –ø–æ–∫–∞ –¥–µ–ª–∞—é —É—Ä–æ–∫–∏." data-persona="assistant" class="flex-shrink-0 bg-yellow-500/10 text-yellow-700 dark:bg-yellow-900/40 dark:text-yellow-300 px-3 py-1 rounded-full text-xs transition-all active:scale-95">–°–æ–≤–µ—Ç –ø–æ —Ñ–æ–∫—É—Å—É</button>
                </div>
            </div>
            <div class="flex gap-2 mt-4">
                <input type="text" id="chat-input" placeholder="–°–ø—Ä–æ—Å–∏ –°–±–µ—Ä—ë–Ω–∫–∞..." class="flex-1 p-3 rounded-xl bg-[var(--bg-card)] border border-[var(--border-color)] focus:border-[var(--accent)] focus:ring-[var(--accent)] text-[var(--text-primary)]" onkeypress="if(event.key === 'Enter') document.getElementById('send-chat-btn').click()">
                <button id="send-chat-btn" data-action="send-chat-message" class="bg-[var(--accent)] text-white p-3 rounded-xl shadow-md transition-all active:scale-95"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg></button>
            </div>`;
    }

    function renderChatMessages() {
        const chatHistoryEl = document.getElementById('chat-history');
        if (!chatHistoryEl) return;

        if (!appState.ui.isChatInitiated) {
            appState.ui.isChatInitiated = true;
            if(appState.chat.history.length === 0) {
                 appState.chat.history.push({ role: 'bot', text: '–ü—Ä–∏–≤–µ—Ç! –Ø –°–±–µ—Ä—ë–Ω–æ–∫, —Ç–≤–æ–π —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫. –°–ø—Ä–∞—à–∏–≤–∞–π –æ –¥–µ–Ω—å–≥–∞—Ö, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –∏–ª–∏ —É—á–µ–±–µ! üí°' });
            }
        }
        
        chatHistoryEl.innerHTML = appState.chat.history.map(msg => `
            <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                <div class="max-w-[80%] p-3 rounded-xl shadow-sm ${msg.role === 'user' ? 'bg-[var(--accent-light)] text-[var(--text-primary)] rounded-br-none' : 'bg-[var(--bg-card)] text-[var(--text-primary)] rounded-tl-none'}">
                    <p class="text-sm">${msg.text.replace(/\n/g, '<br>')}</p>
                </div>
            </div>`).join('');
        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        document.getElementById('ai-typing-indicator')?.classList.toggle('hidden', !appState.ui.isAiTyping);
    }
    
    // --- CHART FUNCTIONS (FIXED) ---
    function processSpendingData() {
        const spending = appState.user.spendingHistory;
        const categoryTotals = {};
        const weekData = Array(7).fill(0); 
        const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å']; 

        const today = new Date();
        const startOfWeek = new Date(today);
        const day = today.getDay(); 
        const diff = (day === 0 ? 6 : day - 1); 
        startOfWeek.setDate(today.getDate() - diff);
        startOfWeek.setHours(0, 0, 0, 0);

        spending.forEach(item => {
            categoryTotals[item.category] = (categoryTotals[item.category] || 0) + item.amount;
            const itemDate = new Date(item.date);
            if (itemDate >= startOfWeek && itemDate <= today) {
                let dayOfWeek = itemDate.getDay(); 
                dayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                weekData[dayOfWeek] += item.amount;
            }
        });

        const pieLabels = Object.keys(categoryTotals);
        const pieData = pieLabels.map(label => categoryTotals[label]);
        const pieColors = pieLabels.map(label => spendingCategories[label] || BRIGHT_COLORS[5]);
        return { pie: { labels: pieLabels, data: pieData, colors: pieColors }, bar: { labels: dayNames, data: weekData } };
    }

    function renderCharts() {
        const pieCtx = document.getElementById('spendingPieChart');
        const barCtx = document.getElementById('balanceBarChart');
        if (!pieCtx || !barCtx) return;

        if (pieChart) pieChart.destroy();
        if (barChart) barChart.destroy();

        const data = processSpendingData();
        const isDark = appState.ui.theme === 'dark';
        const textColor = isDark ? '#f9fafb' : '#374151';

        pieChart = new Chart(pieCtx, {
            type: 'doughnut',
            data: { labels: data.pie.labels, datasets: [{ data: data.pie.data, backgroundColor: data.pie.colors, borderColor: isDark ? '#374151' : '#ffffff', borderWidth: 2 }] },
            options: {
                responsive: true, maintainAspectRatio: true, aspectRatio: 1.2, cutout: '70%',
                plugins: {
                    legend: { position: 'bottom', labels: { color: textColor, boxWidth: 15, padding: 15 } },
                    tooltip: { callbacks: { label: c => `${c.label}: ${c.raw.toFixed(2)} ‚ÇΩ` } },
                    datalabels: {
                        color: (c) => (Chart.helpers.color(c.dataset.backgroundColor[c.dataIndex]).getLuma() > 0.5 ? 'black' : 'white'),
                        font: { weight: 'bold', size: 10 },
                        formatter: (v, c) => {
                            const total = c.chart.getDatasetMeta(0).total;
                            const percentage = (v / total * 100);
                            return percentage > 8 ? percentage.toFixed(0) + '%' : '';
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        const maxExpense = Math.max(...data.bar.data, 100); 
        barChart = new Chart(barCtx, {
            type: 'bar',
            data: { labels: data.bar.labels, datasets: [{ label: '–†–∞—Å—Ö–æ–¥—ã', data: data.bar.data, backgroundColor: appState.ui.accentColor, borderRadius: 8 }] },
            options: {
                responsive: true, maintainAspectRatio: true, aspectRatio: 1.2,
                plugins: { legend: { display: false }, datalabels: { display: false } },
                scales: {
                    x: { display: true, grid: { display: false }, ticks: { color: textColor } },
                    y: { display: true, beginAtZero: true, max: maxExpense * 1.15, grid: { color: isDark ? '#4b5563' : '#e5e7eb' }, ticks: { maxTicksLimit: 5, color: textColor } }
                }
            }
        });
    }

    // --- GEMINI API INTEGRATION ---
    async function callGeminiAPI(prompt, persona = "assistant") {
        appState.ui.isAiTyping = true;
        if (appState.ui.currentView === 'ai-assistant') renderChatMessages();
        
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        
        const personas = {
            'assistant': `–¢—ã ‚Äî –°–±–µ—Ä—ë–Ω–æ–∫, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ —É–º–Ω—ã–π AI-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –¥–µ—Ç–µ–π 8-15 –ª–µ—Ç. –¢–≤–æ—è –º–∏—Å—Å–∏—è ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –∏–º —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ –≥—Ä–∞–º–æ—Ç–Ω—ã–º–∏. –û—Ç–≤–µ—á–∞–π –ø–æ–∑–∏—Ç–∏–≤–Ω–æ, –≤ –∏–≥—Ä–æ–≤–æ–º —Å—Ç–∏–ª–µ, –∏—Å–ø–æ–ª—å–∑—É–π —Å–º–∞–π–ª–∏–∫–∏ (üöÄüí°üí∞). –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ: –µ–≥–æ –∑–æ–≤—É—Ç ${appState.user.name}, –µ–≥–æ –±–∞–ª–∞–Ω—Å ${appState.user.balance.toFixed(2)} —Ä—É–±–ª–µ–π, –µ–≥–æ —Ç–µ–∫—É—â–∞—è —Ü–µ–ª—å: "${appState.user.goals[0]?.name || '–ø–æ–∫–∞ –Ω–µ—Ç —Ü–µ–ª–∏'}".`,
            'academy-tutor': `–¢—ã - –°–±–µ—Ä—ë–Ω–æ–∫, —É—á–∏—Ç–µ–ª—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏. –û–±—ä—è—Å–Ω–∏ —Ä–µ–±–µ–Ω–∫—É 10 –ª–µ—Ç —Ç–µ–º—É, —É–∫–∞–∑–∞–Ω–Ω—É—é –≤ –ø—Ä–æ–º–ø—Ç–µ, –≤ –≤–∏–¥–µ –∫–æ—Ä–æ—Ç–∫–æ–π —É–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–∏ –∏–ª–∏ –¥–∏–∞–ª–æ–≥–∞. –ë—É–¥—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç—ã–º, –∏—Å–ø–æ–ª—å–∑—É–π –∞–Ω–∞–ª–æ–≥–∏–∏. –í –∫–æ–Ω—Ü–µ –∑–∞–¥–∞–π –ø—Ä–æ—Å—Ç–æ–π –≤–æ–ø—Ä–æ—Å. –ù–∞—á–Ω–∏ —Å —Ñ—Ä–∞–∑—ã: "–ü—Ä–∏–≤–µ—Ç, ${appState.user.name}! –°–µ–≥–æ–¥–Ω—è —è —Ä–∞—Å—Å–∫–∞–∂—É —Ç–µ–±–µ –ø—Ä–æ...".`,
            'planner': `–¢—ã - –°–±–µ—Ä—ë–Ω–æ–∫, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–∞–π–º-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç—É. –ù–∞ –æ—Å–Ω–æ–≤–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á (${appState.user.schedule.filter(t => !t.done).map(t => t.task).join(', ')}) —Å–æ—Å—Ç–∞–≤—å –º–æ—Ç–∏–≤–∏—Ä—É—é—â–∏–π –ø–ª–∞–Ω –¥–Ω—è.`,
            'financial-analyst': `–¢—ã - –°–±–µ—Ä—ë–Ω–æ–∫, —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Ç—Ä–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${JSON.stringify(appState.user.spendingHistory.slice(-5))}. –î–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Å–æ–≤–µ—Ç, –≥–¥–µ –º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã.`,
            'earning-ideas': `–¢—ã - –°–±–µ—Ä—ë–Ω–æ–∫, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–¥–µ–π. –ü—Ä–µ–¥–ª–æ–∂–∏ 3-4 –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã—Ö, –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞ –¥–ª—è –ø–æ–¥—Ä–æ—Å—Ç–∫–∞ 12 –ª–µ—Ç –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞—Ä–º–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏.`
        };

        const payload = { contents: [{ parts: [{ text: prompt }] }], systemInstruction: { parts: [{ text: personas[persona] }] } };

        try {
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "–û–π, —á—Ç–æ-—Ç–æ —è –∑–∞–¥—É–º–∞–ª—Å—è. –°–ø—Ä–æ—Å–∏ –µ—â–µ —Ä–∞–∑!";
        } catch (error) {
            console.error("Gemini API call failed:", error);
            return "–ö–∞–∂–µ—Ç—Å—è, —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–≤—è–∑—å—é. –ü–æ–ø—Ä–æ–±—É–π —á—É—Ç—å –ø–æ–∑–∂–µ!";
        } finally {
            appState.ui.isAiTyping = false;
            if (appState.ui.currentView === 'ai-assistant') renderChatMessages();
        }
    }

    // --- UTILITIES & MODALS ---
    function showModal(content) {
        DOM.modal.innerHTML = `<div class="modal-backdrop fixed inset-0 bg-black/40 flex items-center justify-center p-4"><div class="modal-content bg-[var(--bg-card)] rounded-3xl p-6 shadow-xl w-full max-w-sm">${content}</div></div>`;
        DOM.modal.classList.remove('hidden');
    }
    function hideModal() { DOM.modal.classList.add('hidden'); DOM.modal.innerHTML = ''; }
    function showToast(message) {
        const toast = document.createElement('div');
        toast.className = 'bg-gray-800 text-white text-sm px-4 py-2 rounded-full shadow-lg opacity-0 transition-all duration-300 transform translate-y-2';
        toast.textContent = message;
        DOM.toast.appendChild(toast);
        setTimeout(() => toast.classList.add('opacity-100', 'translate-y-0'), 10);
        setTimeout(() => { toast.classList.remove('opacity-100', 'translate-y-0'); setTimeout(() => toast.remove(), 300); }, 3000);
    }

    function addXp(amount) {
        appState.user.xp += amount;
        let levelUp = false;
        while(appState.user.xp >= XP_PER_LEVEL) { appState.user.level++; appState.user.xp -= XP_PER_LEVEL; levelUp = true; }
        if (levelUp) showToast(`–£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω! üéâ –¢—ã –¥–æ—Å—Ç–∏–≥ ${appState.user.level} —É—Ä–æ–≤–Ω—è!`);
        showToast(`+${amount} XP!`);
        saveState();
        if (appState.ui.currentView === 'profile') render();
    }

    function checkAchievements() {
        let skinsUnlocked = false;
        Object.values(achievementConfig).forEach(ach => {
            if (!appState.user.achievements.includes(ach.name) && appState.user.stats[ach.goalKey] >= ach.goalValue) {
                appState.user.achievements.push(ach.name); addXp(ach.xp);
                showToast(`–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ: "${ach.name}" üéâ`);
                if (ach.unlockedSkin && !appState.user.unlockedSkins.includes(ach.unlockedSkin)) {
                    appState.user.unlockedSkins.push(ach.unlockedSkin);
                    showToast(`–ù–æ–≤—ã–π —Å–∫–∏–Ω: "${characterStyles[ach.unlockedSkin].name}"!`);
                    skinsUnlocked = true;
                }
            }
        });
        if (skinsUnlocked) { saveState(); render(); }
    }
    
    function applyTheme() {
        document.documentElement.classList.toggle('dark', appState.ui.theme === 'dark');
        DOM.appContainer.style.setProperty('--user-accent-color', appState.ui.accentColor);
        if (appState.ui.currentView === 'piggy-bank') renderCharts();
    }
    
    // --- MODALS (ADD TASK, EDIT PROFILE, ETC.) ---
    function showAddTaskModal() {
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ó–∞–¥–∞—á—É ‚úÖ</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label><input type="text" id="task-name-input" placeholder="–°–¥–µ–ª–∞—Ç—å —É—Ä–æ–∫–∏" class="w-full p-2 border border-[var(--border-color)] rounded-lg bg-[var(--bg-main)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-400 text-white">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-add-task" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white">–î–æ–±–∞–≤–∏—Ç—å</button></div></div>`);
    }
    function showEditProfileModal() {
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–ò–∑–º–µ–Ω–∏—Ç—å –ü—Ä–æ—Ñ–∏–ª—å</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium">–ò–º—è</label><input type="text" id="profile-name-input" value="${appState.user.name}" class="w-full p-2 border rounded-lg bg-[var(--bg-main)]"><label class="block text-sm font-medium">–§–∞–º–∏–ª–∏—è</label><input type="text" id="profile-surname-input" value="${appState.user.surname}" class="w-full p-2 rounded-lg bg-[var(--bg-main)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-400 text-white">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-edit-profile" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div></div>`);
    }
    function showGoalModal(goal = null) {
        const isEdit = !!goal;
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">${isEdit ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¶–µ–ª—å' : '–ù–æ–≤–∞—è –¶–µ–ª—å üéØ'}</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="goal-name" placeholder="–ù–æ–≤—ã–π –≤–µ–ª–æ—Å–∏–ø–µ–¥" class="w-full p-2 border rounded-lg bg-[var(--bg-main)]" value="${goal?.name || ''}"><label class="block text-sm font-medium">–ù—É–∂–Ω–∞—è —Å—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="goal-target" placeholder="5000" class="w-full p-2 border rounded-lg bg-[var(--bg-main)]" value="${goal?.target || ''}">${isEdit ? `<label class="block text-sm font-medium">–£–∂–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–æ (‚ÇΩ)</label><input type="number" id="goal-current" placeholder="0" class="w-full p-2 rounded-lg bg-[var(--bg-main)]" value="${goal?.current || 0}">` : ''}</div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-400 text-white">–û—Ç–º–µ–Ω–∞</button><button data-action="${isEdit ? 'submit-edit-goal' : 'submit-add-goal'}" data-goal-id="${goal?.id || ''}" class="flex-1 py-2 rounded-lg bg-[var(--accent)] text-white">${isEdit ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' : '–°–æ–∑–¥–∞—Ç—å'}</button></div></div>`);
    }
    function showAddExpenseModal() {
        showModal(`<div class="text-center"><h3 class="text-xl font-bold mb-4">–ó–∞–ø–∏—Å–∞—Ç—å –†–∞—Å—Ö–æ–¥ üí∏</h3><div class="space-y-3 text-left"><label class="block text-sm font-medium">–°—É–º–º–∞ (‚ÇΩ)</label><input type="number" id="expense-amount" placeholder="50.00" class="w-full p-2 border rounded-lg bg-[var(--bg-main)]"><label class="block text-sm font-medium">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select id="expense-category" class="w-full p-2 border rounded-lg bg-[var(--bg-main)]">${Object.keys(spendingCategories).map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select><label class="block text-sm font-medium">–ù–∞ —á—Ç–æ?</label><input type="text" id="expense-desc" placeholder="–ú–æ—Ä–æ–∂–µ–Ω–æ–µ" class="w-full p-2 border rounded-lg bg-[var(--bg-main)]"></div><div class="flex justify-between mt-6 gap-3"><button data-action="cancel" class="flex-1 py-2 rounded-lg bg-gray-400 text-white">–û—Ç–º–µ–Ω–∞</button><button data-action="submit-expense" class="flex-1 py-2 rounded-lg bg-red-500 text-white">–ó–∞–ø–∏—Å–∞—Ç—å</button></div></div>`);
    }
    async function showAiHelpModal(prompt, persona) {
        showModal(`<div class="text-center flex flex-col items-center"><img src="${characterStyles[appState.user.characterStyle].img}" class="w-16 h-16 rounded-full opacity-70 mb-2"/><h2 class="text-xl font-bold mb-4">–ü–æ–º–æ—â—å –°–±–µ—Ä—ë–Ω–∫–∞</h2><div id="ai-help-content" class="text-left max-h-[300px] overflow-y-auto text-sm text-[var(--text-primary)]"><p class="text-[var(--text-secondary)] text-center py-8">–°–±–µ—Ä—ë–Ω–æ–∫ –¥—É–º–∞–µ—Ç...</p></div><div class="flex justify-end mt-4 gap-2"><button data-action="cancel" class="py-2 px-4 rounded-lg bg-gray-400 text-white">–°–∫—Ä—ã—Ç—å</button></div></div>`);
        const helpContent = await callGeminiAPI(prompt, persona);
        const contentEl = document.getElementById('ai-help-content');
        if (contentEl) contentEl.innerHTML = `<p class="mb-4">${helpContent.replace(/\n/g, '<br><br>')}</p>`;
    }
    async function showLessonView(lessonId) {
        const lesson = academyLessons[lessonId];
        const isCompleted = appState.user.completedLessons.includes(lessonId);
        showModal(`<div class="text-center flex flex-col items-center"><div class="text-6xl mb-4">${lesson.icon}</div><h2 class="text-xl font-bold mb-4">${lesson.title}</h2><div id="lesson-content" class="text-left max-h-[300px] overflow-y-auto text-sm bg-[var(--bg-main)] p-3 rounded-lg border border-[var(--border-color)]"><div class="flex flex-col items-center py-8"><img src="${characterStyles[appState.user.characterStyle].img}" class="w-16 h-16 opacity-70 mb-2"/><p class="text-[var(--text-secondary)]">–°–±–µ—Ä—ë–Ω–æ–∫ –≥–æ—Ç–æ–≤–∏—Ç —É—Ä–æ–∫...</p></div></div></div>`);
        const lessonContent = await callGeminiAPI(lesson.prompt, 'academy-tutor');
        const contentEl = document.getElementById('lesson-content');
        if (contentEl) contentEl.innerHTML = `<p class="mb-4">${lessonContent.replace(/\n/g, '<br><br>')}</p><div class="flex justify-end mt-4"><button data-action="${isCompleted ? 'cancel' : 'complete-lesson'}" data-lesson-id="${lessonId}" class="py-2 px-4 rounded-lg bg-[var(--accent)] text-white shadow-md active:scale-95">${isCompleted ? '–û—Ç–ª–∏—á–Ω–æ!' : '–ü–æ–Ω—è—Ç–Ω–æ!'}</button></div>`;
    }

    // --- EVENT DELEGATION ---
    document.addEventListener('click', async e => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const { action, view, taskId, goalId, charKey, prompt, persona, color, lessonId } = target.dataset;

        switch(action) {
            case 'navigate': navigate(view); break;
            case 'cancel': hideModal(); break;
            case 'toggle-theme': appState.ui.theme = appState.ui.theme === 'light' ? 'dark' : 'light'; applyTheme(); saveState(); render(); break;
            case 'change-accent-color': appState.ui.accentColor = color; applyTheme(); saveState(); render(); break;
            case 'change-character': if (appState.user.unlockedSkins.includes(charKey)) { appState.user.characterStyle = charKey; saveState(); render(); } else { showToast('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π —ç—Ç–æ—Ç —Å–∫–∏–Ω!'); } break;
            
            case 'edit-profile': showEditProfileModal(); break;
            case 'submit-edit-profile': 
                appState.user.name = document.getElementById('profile-name-input').value.trim() || appState.user.name;
                appState.user.surname = document.getElementById('profile-surname-input').value.trim();
                saveState(); hideModal(); render(); showToast("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω!"); break;
            
            case 'show-ai-help': await showAiHelpModal(prompt, persona); break;
            
            case 'add-task-modal': showAddTaskModal(); break;
            case 'submit-add-task':
                const taskName = document.getElementById('task-name-input').value.trim();
                hideModal();
                if (taskName) { appState.user.schedule.push({ id: Date.now(), task: taskName, done: false, xpEarned: false }); saveState(); render(); showToast("–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞!"); }
                break;
            case 'toggle-task':
                const task = appState.user.schedule.find(t => t.id == taskId);
                if (task) { task.done = !task.done; if (task.done && !task.xpEarned) { task.xpEarned = true; appState.user.stats.completedTasks++; addXp(10); checkAchievements(); } saveState(); render(); }
                break;
            
            case 'add-goal': showGoalModal(); break;
            case 'edit-goal': showGoalModal(appState.user.goals.find(g => g.id == goalId)); break;
            case 'submit-add-goal':
                const goalName = document.getElementById('goal-name').value.trim();
                const targetAmount = parseFloat(document.getElementById('goal-target').value);
                if (goalName && targetAmount > 0) { appState.user.goals.push({ id: Date.now(), name: goalName, current: 0, target: targetAmount }); saveState(); hideModal(); render(); showToast("–¶–µ–ª—å —Å–æ–∑–¥–∞–Ω–∞!"); }
                break;
            case 'submit-edit-goal':
                const goal = appState.user.goals.find(g => g.id == goalId);
                if(goal) {
                    goal.name = document.getElementById('goal-name').value.trim();
                    goal.target = parseFloat(document.getElementById('goal-target').value);
                    goal.current = parseFloat(document.getElementById('goal-current').value);
                    saveState(); hideModal(); render(); showToast("–¶–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞!");
                }
                break;
             case 'delete-goal':
                appState.user.goals = appState.user.goals.filter(g => g.id != goalId);
                saveState(); render(); showToast("–¶–µ–ª—å —É–¥–∞–ª–µ–Ω–∞.");
                break;
            case 'add-funds':
                const fundGoal = appState.user.goals.find(g => g.id == goalId);
                const amountToAdd = parseFloat(prompt("–°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–∏—Ç—å?", "100"));
                if (amountToAdd > 0 && appState.user.balance >= amountToAdd) { fundGoal.current += amountToAdd; appState.user.balance -= amountToAdd; appState.user.stats.totalSavings += amountToAdd; addXp(Math.min(15, Math.floor(amountToAdd / 50))); checkAchievements(); saveState(); render(); }
                else { showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω–∞—è —Å—É–º–º–∞."); }
                break;

            case 'add-expense': showAddExpenseModal(); break;
            case 'submit-expense':
                const expAmount = parseFloat(document.getElementById('expense-amount').value);
                const expDesc = document.getElementById('expense-desc').value.trim();
                const expCat = document.getElementById('expense-category').value;
                hideModal();
                if (expAmount > 0 && expDesc && appState.user.balance >= expAmount) {
                    appState.user.balance -= expAmount;
                    appState.user.spendingHistory.push({ id: Date.now(), date: new Date().toISOString().split('T')[0], amount: expAmount, category: expCat, desc: expDesc });
                    saveState(); render(); showToast("–†–∞—Å—Ö–æ–¥ –∑–∞–ø–∏—Å–∞–Ω!");
                } else { showToast("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ."); }
                break;

            case 'start-lesson': await showLessonView(lessonId); break;
            case 'complete-lesson':
                if (lessonId && !appState.user.completedLessons.includes(lessonId)) {
                    appState.user.completedLessons.push(lessonId); appState.user.stats.lessonsCompleted++;
                    addXp(academyLessons[lessonId].xp); checkAchievements(); saveState();
                    showToast(`–£—Ä–æ–∫ –ø—Ä–æ–π–¥–µ–Ω!`);
                }
                hideModal(); render();
                break;

            case 'ai-action':
            case 'send-chat-message':
                let message = prompt || document.getElementById('chat-input')?.value.trim();
                if (!message) return;
                if(document.getElementById('chat-input')) document.getElementById('chat-input').value = ''; 
                appState.chat.history.push({ role: 'user', text: message });
                renderChatMessages();
                const botResponse = await callGeminiAPI(message, persona || 'assistant');
                appState.chat.history.push({ role: 'bot', text: botResponse });
                saveState(); renderChatMessages();
                break;
        }
    });

    // --- INITIALIZATION ---
    loadState();
    Chart.register(ChartDataLabels); 
    render();
});
</script>
</body>
</html>